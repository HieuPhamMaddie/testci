version: '2.1'
orbs:
  docker: circleci/docker@2.3.0

jobs:
  build-and-push:
    executor: docker/docker
    steps:
      - setup_remote_docker
      - checkout
      - docker/check
      - run:
          name: Set Docker Image Tag
          command: |
            if [ "${CIRCLE_BRANCH}" == "develop" ]; then
              DOCKER_IMAGE_TAG="dev-${CIRCLE_BUILD_NUM}"
            else
              DOCKER_IMAGE_TAG="prod-${CIRCLE_BUILD_NUM}"
            fi
            echo "DOCKER_IMAGE_TAG=${DOCKER_IMAGE_TAG}" >> $BASH_ENV
      - docker/build:
          image: hieuphamdn93/nodetest
          tag: $DOCKER_IMAGE_TAG
      - docker/push:
          digest-path: /tmp/digest.txt
          image: hieuphamdn93/nodetest
          tag: $DOCKER_IMAGE_TAG
      - run:
          command: |
            echo "Digest is: $(</tmp/digest.txt)"
  say_hello:
    docker:
     - image: cimg/base:2022.05
    steps:
      - run: echo "Say hello to YAML!"
workflows:
  commit:
    jobs:
      - build-and-push:
          context: my-docker-credentials
      - say_hello:
          requires:
            - build-and-push
